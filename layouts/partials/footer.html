<div data-aos="fade-up" data-aos-delay="200" data-aos-duration="2000" class="col-span-1 col-span-2 p-4 w-full mt-6 text-center border-t border-gray-300 dark:border-gray-800/50 mb-[16%] lg:mb-0">
  <p>&copy; {{ now.Year }} {{ .Site.Title }}. Hak cipta dilindungi.</p>
</div>
{{ if ne .Kind "404" }}
  {{ partial "notif-data.html" . }}
{{ end }}

{{ if eq hugo.Environment "development" }}
  {{ partial "_safelist.html" . }}
{{ end }}

<noscript>
  <style>
    .divDistortion::before {
      content: "⚠️ Hover effect nonaktif (JavaScript diperlukan)";
      display: block;
      padding: 1rem;
      color: #999;
      font-size: 0.9rem;
      text-align: center;
      background: #f0f0f0;
    }
    .divDistortion img, [data-aos] {
      opacity: 1 !important;
      transform: none !important;
      filter: none !important;
    }
  </style>
</noscript>

<!-- Umami Analytics -->
<script defer src="https://umami.conime.id/script.js" data-website-id="393718b0-0b72-40af-b425-0615a698d999"></script>

<!-- AOS (Animate On Scroll) -->
<script src="https://cdn.jsdelivr.net/npm/aos@2.3.1/dist/aos.js"></script>
<script>
  AOS.init({
    duration: 1200,
    delay: 0,
    once: true,
  });
</script>

<!-- ============= LIBRARY EXTERNAL ============= -->
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>
<script defer>
  tippy('[data-tippy-content]');
</script>

{{ with resources.Get "js/three.min.js" }}
  {{ $min := . | resources.Minify }}
  <script src="{{ $min.RelPermalink }}" defer></script>
{{ end }}

{{ with resources.Get "js/gsap.min.js" }}
  {{ $min := . | resources.Minify }}
  <script src="{{ $min.RelPermalink }}" defer></script>
{{ end }}

{{ with resources.Get "js/hover-effect.umd.js" }}
  {{ $min := . | resources.Minify }}
  <script src="{{ $min.RelPermalink }}" defer></script>
{{ end }}

<!-- ============= MAIN BUNDLE UNTUK SEMUA HALAMAN ============= -->
{{ with resources.Get "js/main.js" }}
  {{ $min := . | resources.Minify }}
  <script src="{{ $min.RelPermalink }}" defer></script>
{{ end }}

{{ with resources.Get "js/notif.js" }}
  {{ $min := . | resources.Minify }}
  <script src="{{ $min.RelPermalink }}" defer></script>
{{ end }}

{{ with resources.Get "js/last-view.js" }}
  {{ $min := . | resources.Minify }}
  <script src="{{ $min.RelPermalink }}" defer></script>
{{ end }}

{{ with resources.Get "js/popular-umami.js" }}
  {{ $min := . | resources.Minify }}
  <script src="{{ $min.RelPermalink }}" defer></script>
{{ end }}

<!-- ============= KHUSUS HOMEPAGE ============= -->
{{ if eq .RelPermalink "/" }}
  {{ with resources.Get "js/loading-animation.js" }}
    {{ $min := . | resources.Minify }}
    <script src="{{ $min.RelPermalink }}" defer></script>
  {{ end }}
{{ end }}

{{ with resources.Get "js/hover-init.js" }}
  {{ $min := . | resources.Minify }}
  <script src="{{ $min.RelPermalink }}" defer></script>
{{ end }}

<!-- Inisialisasi Tippy untuk SEMUA elemen -->
<script>
  tippy('[data-tippy-content]');
</script>



<!--
<script>
function escapeHtmlAttr(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/"/g, '&quot;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}

function cleanJsonString(value) {
  if (typeof value === 'string') {
    // Remove extra wrapping quotes if it looks like "\"...\""
    if (value.startsWith('"') && value.endsWith('"')) {
      try {
        return JSON.parse(value);
      } catch (_) {
        return value;
      }
    }
    return value;
  }
  return value;
}

function cleanCategories(categories) {
  if (typeof categories === 'string') {
    try {
      return JSON.parse(categories);
    } catch (_) {
      return [];
    }
  }
  if (Array.isArray(categories)) {
    return categories;
  }
  return [];
}

document.addEventListener('DOMContentLoaded', async () => {
  const container = document.getElementById('popular-container');
  if (!container) return;

  container.innerHTML = '<p class="text-gray-500">Loading popular posts...</p>';

  try {
    // 1. Fetch popular paths from Netlify Function
    const res = await fetch('/.netlify/functions/getPopularPosts');
    const popularRaw = await res.json();

    // 2. Only keep /posts/*/*/
    const filtered = popularRaw.filter(p => {
      const segments = p.url.split('/').filter(s => s);
      return segments.length === 3;
    }).slice(0, 5);

    // 3. Get Hugo metadata
    const metadataJSON = document.getElementById('post-metadata').textContent;
    const metadata = JSON.parse(metadataJSON);

    // 4. Join popular data with Hugo metadata
    const posts = filtered.map(p => {
      const match = metadata.find(m => m.url === p.url);

      const titleRaw = match ? match.title : p.title;
      const title = cleanJsonString(titleRaw);

      const categoriesRaw = match ? match.categories : [];
      const categories = cleanCategories(categoriesRaw);

      const image = match ? match.image : '/images/default.png';
      const date = match ? match.date : new Date(p.date).toISOString().split('T')[0];

      return {
        url: p.url,
        title,
        image,
        categories,
        date
      };
    });

    // 5. Render with your exact Tailwind layout
    container.innerHTML = posts.map((post, i) => `
      <ul class="relative group flex flex-col justify-center w-full h-auto">
        <li data-aos="fade-up" data-aos-delay="${i * 200}" data-aos-duration="2000"
          class="relative popular-html flex flex-col w-full h-full bg-white dark:bg-gray-950 hover:bg-gray-300 hover:dark:bg-gray-950/20 overflow-hidden rounded-xl shadow-lg shadow-gray-700/40 dark:shadow-gray-950/40 transition duration-300 ease-in-out">

          <a href="${post.url}" class="bg-cover w-full h-full overflow-hidden transition duration-500 ease-in-out">
            <img loading="lazy" src="${post.image}" alt="Gambar ${escapeHtmlAttr(post.title)}" class="w-full h-[360px] object-cover rounded-t-xl brightness-75 hover:brightness-100 transition duration-300 ease-in-out" />
          </a>

          <div data-aos="fade-up" data-aos-delay="${i * 200}" data-aos-duration="2000"
            class="w-full lg:w-[70%] h-[60%] lg:h-[70%] group absolute bottom-0 left-0 rounded-tr-3xl transition duration-500 ease-in-out font-light dark:font-extralight flex flex-col items-start justify-start gap-2 p-4 bg-white dark:bg-gray-950 hover:bg-gray-300 hover:dark:bg-gray-900">

            <h2 class="w-fit inline-block lg:hidden"> —0${i + 1}</h2>
            <h2 class="w-[80%] lg:w-full h-fit text-2xl line-clamp-3 opacity-100 lg:opacity-0 group-hover:lg:opacity-100 group-hover:z-10 transition duration-500 ease-in-out">
              <a href="${post.url}" class="hover:underline break-words" title="${escapeHtmlAttr(post.title)}">${escapeHtmlAttr(post.title)}</a>
            </h2>
            <h2 class="flex justify-between opacity-100 lg:opacity-0 group-hover:lg:opacity-100 group-hover:z-10 transition duration-500 ease-in-out gap-4 text-sm line-clamp-1 uppercase">
              ${post.categories.map(cat => `<a href="/categories/${encodeURIComponent(cat)}" class="hover:underline">${escapeHtmlAttr(cat)}</a>`).join(' ')}
            </h2>
            <p class="bottom-4 items-end justify-end w-full left-6 z-10 text-xl h-full flex-1 flex gap-0 opacity-100 lg:opacity-0 group-hover:lg:opacity-100 group-hover:z-10 transition duration-500 ease-in-out">
              <span>—</span>${escapeHtmlAttr(post.date)}
            </p>
            <h2 class="absolute inset-0 text-gray-500 dark:text-gray-900 text-5xl w-1 h-1 lg:w-full lg:h-full flex items-center justify-center font-bold opacity-0 lg:opacity-100 dark:lg:opacity-100 group-hover:lg:opacity-0 group-hover:-z-10 transition duration-500 ease-in-out">
              #${i + 1}
            </h2>
          </div>
        </li>
      </ul>
    `).join('');

  } catch (error) {
    console.error(error);
    container.innerHTML = '<p class="text-red-500 text-sm">⚠️ Error loading popular posts.</p>';
  }
});
</script>

-->
<script>
function escapeHtmlAttr(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/"/g, '&quot;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}

function normalizeUrl(url) {
  return decodeURIComponent(url || '').replace(/\/$/, '').toLowerCase();
}

function safeParseCategories(input) {
  if (Array.isArray(input)) return input;
  if (typeof input === 'string') {
    try { return JSON.parse(input); } catch { return []; }
  }
  return [];
}

function cleanTitle(str) {
  return (str || '').replace(/^"(.*)"$/, '$1').trim();
}

function formatDate(date) {
  if (!date) return '';
  return date.split('T')[0];
}

document.addEventListener('DOMContentLoaded', async () => {
  const container = document.getElementById('popular-container');
  if (!container) return;

  const staticHTML = container.innerHTML;

  // Ambil metadata lokal Hugo (yang lengkap)
  let metadata = [];
  try {
    const metadataJSON = document.getElementById('post-metadata')?.textContent;
    if (metadataJSON) {
      metadata = JSON.parse(metadataJSON).map(p => ({
        ...p,
        title: cleanTitle(p.title),
        categories: safeParseCategories(p.categories)
      }));
    }
  } catch (err) {
    console.error('⚠️ Error parsing local post metadata:', err);
  }

  // 1️⃣ Coba fetch dari serverless function
  let popularRaw = null;
  try {
    const res = await fetch('/.netlify/functions/getPopularPosts');
    if (res.ok) {
      popularRaw = await res.json();
    } else {
      console.warn('⚠️ Remote fetch failed with non-200');
    }
  } catch (err) {
    console.warn('⚠️ Remote fetch error:', err);
  }

  // 2️⃣ Kalau gagal fetch, fallback ke top N dari local metadata
  if (!popularRaw || !popularRaw.length) {
    console.warn('⚠️ Using local fallback');
    popularRaw = metadata
      .sort((a, b) => b.date.localeCompare(a.date))
      .slice(0, 5)
      .map(item => ({ url: item.url, date: item.date }));
  }

  // 3️⃣ Join popularRaw with metadata to get full info
  const posts = popularRaw.map(p => {
    const match = metadata.find(m => normalizeUrl(m.url) === normalizeUrl(p.url));
    return {
      url: p.url || match?.url || '#',
      title: cleanTitle(match?.title || 'Judul Tidak Tersedia'),
      image: match?.image || '/images/default.png',
      categories: safeParseCategories(match?.categories || []),
      date: formatDate(p.date || match?.date || new Date().toISOString())
    };
  });

  if (!posts.length) {
    console.warn('⚠️ No posts to render. Leaving Hugo static.');
    container.innerHTML = staticHTML;
    return;
  }

  // 4️⃣ Render
  container.innerHTML = posts.map((post, i) => `
    <ul class="relative group flex flex-col justify-center w-full h-auto">
      <li data-aos="fade-up" data-aos-delay="${i * 200}" data-aos-duration="2000"
          class="relative opacity-[1] popular-html flex flex-col w-full h-full bg-white dark:bg-gray-950 hover:bg-gray-300 hover:dark:bg-gray-950/20 overflow-hidden rounded-xl shadow-lg shadow-gray-700/40 dark:shadow-gray-950/40 transition duration-300 ease-in-out">

        <a href="${post.url}" class="bg-cover w-full h-full overflow-hidden transition duration-500 ease-in-out">
          <img loading="lazy" src="${post.image}" alt="Gambar ${escapeHtmlAttr(post.title)}"
               class="w-full h-[360px] object-cover rounded-t-xl brightness-75 hover:brightness-100 transition duration-300 ease-in-out" />
        </a>

        <div data-aos="fade-up" data-aos-delay="${i * 200}" data-aos-duration="2000"
             class="w-full lg:w-[70%] h-[60%] lg:h-[70%] group absolute bottom-0 left-0 rounded-tr-3xl transition duration-500 ease-in-out font-light dark:font-extralight flex flex-col items-start justify-start gap-2 p-4 bg-white dark:bg-gray-950 hover:bg-gray-300 hover:dark:bg-gray-900">

          <h2 class="w-fit inline-block lg:hidden"> —0${i + 1}</h2>
          <h2 class="w-[80%] lg:w-full h-fit text-2xl line-clamp-3 opacity-100 lg:opacity-0 group-hover:lg:opacity-100 group-hover:z-10 transition duration-500 ease-in-out">
            <a href="${post.url}" class="hover:underline break-words" title="${escapeHtmlAttr(post.title)}">
              ${escapeHtmlAttr(post.title)}
            </a>
          </h2>
          <h2 class="flex justify-between opacity-100 lg:opacity-0 group-hover:lg:opacity-100 group-hover:z-10 transition duration-500 ease-in-out gap-4 text-sm line-clamp-1 uppercase">
            ${(post.categories || []).map(cat => `
              <a href="/categories/${encodeURIComponent(cat)}" class="hover:underline">${escapeHtmlAttr(cat)}</a>`).join(' ')}
          </h2>
          <p class="bottom-4 items-end justify-end w-full left-6 z-10 text-xl h-full flex-1 flex gap-0 opacity-100 lg:opacity-0 group-hover:lg:opacity-100 group-hover:z-10 transition duration-500 ease-in-out">
            <span>—</span>${escapeHtmlAttr(post.date)}
          </p>
          <h2 class="absolute inset-0 text-gray-500 dark:text-gray-900 text-5xl w-1 h-1 lg:w-full lg:h-full flex items-center justify-center font-bold opacity-0 lg:opacity-100 dark:lg:opacity-100 group-hover:lg:opacity-0 group-hover:-z-10 transition duration-500 ease-in-out">
            #${i + 1}
          </h2>
        </div>
      </li>
    </ul>
  `).join('');

  // 5️⃣ Refresh AOS (if available)
  if (window.AOS && typeof window.AOS.refresh === 'function') {
    window.AOS.refresh();
  }
});
</script>



{{ if hugo.IsServer }}
<!--

<script>
 const postData = document.getElementById('post-metadata');
const posts = postData ? JSON.parse(postData.textContent.replace(/\\\//g, '/')) : [];

const getMetadata = (path) => {
  const match = posts.find(p => p.permalink === path);
  if (!match) console.warn("❌ Metadata tidak ditemukan untuk:", path);
  return match;
};

const popularContainer = document.getElementById("popular-news");
const fallbackContent = document.getElementById("recommended-fallback");

const getLast7DaysRange = () => {
  const end = new Date();
  const start = new Date();
  start.setDate(end.getDate() - 7);
  return {
    start: start.toISOString().split('T')[0],
    end: end.toISOString().split('T')[0]
  };
};

const renderPopular = (items, label = "Popular This Week", isFallback = false) => {
  let html = `
    <h2 class="text-xl uppercase font-medium border-b pb-2 mb-4">${label}</h2>
    <ul class="flex flex-row gap-4">`;

  items.forEach((item, i) => {
    const meta = getMetadata(item.url || item.permalink) || item;
    const title = meta.title || "No Title";
    const image = meta.image || "/images/default.png";
    const link = meta.permalink || item.url || "#";

    html += `
      <li class="relative popular-html flex flex-col col-span-2 w-full h-full bg-gradient-to-br from-white dark:from-gray-900 via-gray-50 dark:via-gray-950 to-gray-300 dark:to-gray-950 overflow-hidden rounded-xl shadow-lg shadow-gray-700/40 dark:shadow-gray-950/40 transition duration-300 ease-in-out">
        <a href="${link}" class="bg-cover w-full h-full overflow-hidden transition duration-500 ease-in-out">
          <img loading="lazy" src="${image}" alt="Gambar ${title}" class="w-full h-[360px] object-cover rounded-t-xl brightness-75 hover:brightness-100 transition duration-300 ease-in-out" />
        </a>
        <div class="w-[70%] h-[70%] absolute bottom-0 left-0 rounded-tr-3xl transition duration-500 ease-in-out font-light dark:font-extralight flex flex-col items-start justify-start gap-2 p-4 bg-gradient-to-br from-white dark:from-gray-900 via-gray-50 dark:via-gray-950 to-gray-300 dark:to-gray-950">
          <h2 class="w-full h-fit text-2xl line-clamp-3 ${isFallback ? '' : 'opacity-0 group-hover:opacity-100 group-hover:z-10'} transition duration-500 ease-in-out">
            <a href="${link}" class="hover:underline break-words">${title}</a>
          </h2>
          <p class="text-sm text-zinc-600 dark:text-zinc-300 ${isFallback ? '' : 'opacity-0 group-hover:opacity-100 group-hover:z-10'}">— ${label}</p>
        </div>
      </li>`;
  });

  html += `</ul>`;
  popularContainer.innerHTML = html;
};

// Main
if (popularContainer && posts.length > 0) {
  const { start, end } = getLast7DaysRange();
  const websiteId = "fabe1eb6-5122-4712-b095-5ec2ab778540";
  const apiKey = "api_XcrHJ2uDyFNEodCAgoSdRaLC8ybFf0XO";

  fetch(`https://cloud.umami.is/api/websites/${websiteId}/stats/pages?start=${start}&end=${end}`, {
    headers: { Authorization: `Bearer ${apiKey}` }
  })
    .then(res => res.json())
    .then(data => {
      const filtered = (data?.data || [])
        .filter(p => p.url.startsWith("/posts/"))
        .sort((a, b) => b.visits - a.visits)
        .slice(0, 5);

      if (!filtered.length) throw new Error("⚠️ Data kosong");

      renderPopular(filtered);
      fallbackContent?.classList.add("hidden");
      console.log("✅ Popular posts ditampilkan dari Umami.");
    })
    .catch(err => {
      console.warn("💥 Gagal ambil dari Umami, pakai fallback:", err);
      renderPopular(posts.slice(0, 4), "Recommended", true);
      fallbackContent?.classList.add("flex");
    });
} else {
  console.warn("🚫 Elemen popular-news tidak ditemukan atau metadata kosong.");
}

</script>
-->

{{ end }}